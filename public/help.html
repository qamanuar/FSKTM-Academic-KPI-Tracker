<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Help & Support</title>

  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href = "/css/sidebar.css" rel="stylesheet">

<style>
    :root {
  --bs-primary: #6f42c1;
  --bs-primary-dark: #5a32a3;
  --bs-light-bg: #f4f0fa;
}

body {
  /* font-family: 'Poppins', sans-serif; */
  background-color: var(--bs-light-bg);
  margin: 0;
}

.main-content {
  margin-left: 90px;
  padding: 2rem;
  flex-grow: 1;
  padding-top: 90px; /* ← Push content below the fixed header */
  font-family: 'Poppins';
  position: relative;
  width: calc(100% - 78px);
  left: 50px;
  justify-content: center;
  flex: 1 0 auto;
}


  header {
    background-color: rgb(222, 204, 255);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    padding: 1rem;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    text-align: center;
    justify-content: center;
    z-index: 1001;
    height: 70px;
  }

  .header-container{
    display: flex;
    justify-content: space-between;
  }

  header ul{
    justify-content: space-between;
    display: flex;
    gap: 10rem;
  }

body, html {
  height: 100%;
  margin: 0;
  display: flex;
  flex-direction: column;
}

/* Only fix the arrow conflict from Tailwind's preflight */
.accordion-button::after {
  background-image: none !important;
}
.spinner {
  display: inline-block;
  width: 1rem;
  height: 1rem;
  border: 2px solid rgba(255,255,255,0.3);
  border-radius: 50%;
  border-top-color: white;
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

</style>

</head>
  <!-- Header -->
   <header class="items-center flex justify-content-between">
        <img src="./assets/images/fsktm-kpi-logo.png" alt="Logo" style="height: 60px; margin-left:30px">  
        <div>
          <ul class="flex gap-lg-5">
            <li id="username" class="text-lg justify-center text-[#2e067d] mt-1 font-medium"></li>
            <li class="mt-1">
                <a href="/General.html" class=" text-lg text-[#2e067d] border-2 border-[#2e067d] py-1 px-3 rounded-lg 
                hover:bg-[#2e067d] hover:text-white transition duration-200">
                Logout</a>
            </li>
          </ul>
        </div>
    </header>

  <div class="flex flex-1">
  <!-- Side Navigation Bar -->
  <div class = "sidebar">
    <div class = "logo_content">
      <div class="logo">
          <i class='bx bxs-bar-chart-alt-2'></i>
          <div class="logo_name">FSKTM KPI Tracker</div>
        </div>
      <i class='bx bx-menu' id = "btn" >
        <span class = "tooltip">Menu</span>
      </i>
      <ul class="nav_list">
        <li>
          <a href = "profile.html">
            <i class='bx bx-user'></i>
            <span class="links_name">My Account</span>
          </a>
          <span class="tooltip">My Account</span>
        </li>
        <li>
          <a href="LecturerDashboard.html">
            <i class='bx bxs-dashboard'></i>
            <span class="links_name">Lecturer Dashboard</span>
          </a>
          <span class="tooltip">KPI Dashboard</span>
          
          <!--Revisit-->
          <!-- Submenu starts here -->
          <!-- <ul class="submenu">
            <li><a href="#">KPI Overview</a></li>
            <li><a href="#">KPI Management</a></li>
            <li><a href="#">KPI Verification</a></li>
          </ul>
        </li> -->

        <li>
          <a href = "Student_Dash.html">
            <i class='bx bxs-dashboard' ></i>
            <span class="links_name">Student Dashboard</span>
          </a>
          <span class="tooltip">KPI Dashboard</span>
        </li>
        <li>
          <a href = "notification.html">
            <i class='bx bxs-bell'></i>
            <span class="links_name">Notifications</span>
          </a>
          <span class="tooltip">Notifications</span>
        </li>
        <li>
          <a href = "help.html">
            <i class='bx bx-question-mark'></i>
            <span class="links_name">Help & Support</span>
          </a>
          <span class="tooltip">Help & Support</span>
        </li>
      </ul>
    </div>
  </div>

     <main class="flex-1 p-4 bg-gray-100 mainPage">
      <div class="main-content">
        <h2 class="mb-4 fw-bold fs-2">Help & Support</h2>

<!-- FAQ Section -->
<div class="mb-8">
  <h4 class="text-xl font-semibold mb-5 text-gray-800">Frequently Asked Questions</h4>
  <button 
    onclick="loadFAQs()" 
    class="px-4 py-2 mb-4 text-sm font-medium text-purple-600 border border-purple-600 rounded-lg hover:bg-purple-600 hover:text-white transition duration-200"
  >
    Load FAQs
  </button>
  
  <div class="faq-items-container space-y-4"></div>
</div>

<!-- Feedback Section -->
<div class="feedback-section">
  <!-- Feedback Form -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h4 class="mb-0">Submit Feedback</h4>
    </div>
    <div class="card-body">
      <form id="feedbackForm" class="mb-4">
        <div class="mb-3">
          <label for="email" class="form-label">Your Email</label>
         <input type="email" id="email" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="message" class="form-label">Message</label>
          <textarea id="message" rows="4" class="form-control" required></textarea>
        </div>
        <button type="submit" class="btn btn-primary w-100" id="submitBtn">
          Submit Feedback
        </button>
      </form>
      <div id="feedbackResponse" class="alert d-none"></div>
    </div>
  </div>

  <!-- Feedback List -->
  <div class="card">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Recent Feedback</h5>
      <button class="btn btn-sm btn-outline-primary" id="refreshFeedbackBtn">
        <i class="bi bi-arrow-clockwise"></i> Refresh
      </button>
    </div>
    <div class="card-body p-0">
      <ul id="feedbackList" class="list-group list-group-flush">
        <li class="list-group-item text-center py-4 text-muted">
          No feedback yet. Be the first to submit!
        </li>
      </ul>
    </div>
  </div>
</div>

<!-- Feedback Details Modal -->
<div class="modal fade" id="feedbackModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Feedback Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="modalContent">
        <div class="mb-3">
          <label class="form-label text-muted small">Name</label>
          <p id="modalName" class="mb-2"></p>
        </div>
        <div class="mb-3">
          <label class="form-label text-muted small">Email</label>
          <p id="modalEmail" class="mb-2"></p>
        </div>
        <div class="mb-3">
          <label class="form-label text-muted small">Message</label>
          <p id="modalMessage" class="mb-2"></p>
        </div>
        <div class="mb-3">
          <label class="form-label text-muted small">Submitted</label>
          <p id="modalDate" class="mb-2"></p>
        </div>
      </div>
      <div class="modal-footer" id="modalFooter">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

      <p class="text-white text-sm mr-10">COPYRIGHT 2025 © FSKTM KPI Tracker</p>
</footer>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Global variables
let currentFeedbackId = null;
let currentUserId = null;

// DOM Elements
const feedbackForm = document.getElementById("feedbackForm");
const feedbackResponse = document.getElementById("feedbackResponse");
const feedbackList = document.getElementById("feedbackList");
const refreshFeedbackBtn = document.getElementById("refreshFeedbackBtn");
const cancelEditBtn = document.getElementById("cancelEditBtn");

// Base API URL
const API_BASE_URL = 'http://localhost:3000/api/tickets';

// Initialize on page load
document.addEventListener("DOMContentLoaded", () => {
  const session = JSON.parse(localStorage.getItem("userSession"));
  currentUserId = session?.id;

  fetchFeedbacks();
  setupEventListeners();
  setupFormValidation();
});

function setupEventListeners() {
  feedbackForm.addEventListener("submit", handleFormSubmit);
  refreshFeedbackBtn.addEventListener("click", fetchFeedbacks);
  cancelEditBtn?.addEventListener("click", cancelEdit);
}

async function handleFormSubmit(e) {
  e.preventDefault();
  const submitBtn = document.getElementById("submitBtn");

  try {
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner">Sending...</span>';

    const formData = {
      email: document.getElementById("email").value,
      message: document.getElementById("message").value,
      userId: currentUserId || null
    };

    const method = currentFeedbackId ? 'PUT' : 'POST';
    const url = currentFeedbackId
      ? `${API_BASE_URL}/feedback/${currentFeedbackId}`
      : `${API_BASE_URL}/feedback`;

    const response = await fetch(url, {
      method,
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify(formData)
    });

    const contentType = response.headers.get('content-type');
    if (!contentType || !contentType.includes('application/json')) {
      const text = await response.text();
      throw new Error(text || 'Server returned non-JSON response');
    }

    const data = await response.json();
    if (!response.ok) throw new Error(data.message || 'Operation failed');

    showAlert(currentFeedbackId ? 'Feedback updated!' : 'Feedback submitted!', 'success');
    feedbackForm.reset();
    cancelEdit();
    fetchFeedbacks();
  } catch (error) {
    console.error('Submission error:', error);
    showAlert(error.message || 'Operation failed', 'danger');
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerHTML = currentFeedbackId ? 'Update Feedback' : 'Submit Feedback';
  }
}

async function fetchFeedbacks() {
  feedbackList.innerHTML = '<li class="list-group-item text-center py-3">Loading feedback...</li>';
  try {
    const res = await fetch(`${API_BASE_URL}/feedback`);
    if (!res.ok) throw new Error('Failed to load feedback');

    const feedbacks = await res.json();
    renderFeedbacks(feedbacks);
  } catch (error) {
    feedbackList.innerHTML = `
      <li class="list-group-item text-center text-danger py-3">
        ${error.message}
        <button onclick="fetchFeedbacks()" class="btn btn-sm btn-link">Retry</button>
      </li>`;
  }
}

function renderFeedbacks(feedbacks) {
  feedbackList.innerHTML = feedbacks.length > 0
    ? feedbacks.map(fb => `
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <strong>${fb.name || fb.user || 'User'}</strong>
          <small class="text-muted d-block">${fb.email}</small>
          <div>${fb.message.substring(0, 50)}...</div>
        </div>
        <div>
          ${fb.userId === currentUserId ? `
            <button onclick="editFeedback('${fb._id}')" class="btn btn-sm btn-outline-primary me-2">Edit</button>
          ` : ''}
          <button onclick="viewFeedback('${fb._id}')" class="btn btn-sm btn-outline-info">View</button>
        </div>
      </li>
    `).join('')
    : '<li class="list-group-item text-center py-3">No feedback submitted yet</li>';
}

async function viewFeedback(id) {
  try {
    const res = await fetch(`${API_BASE_URL}/feedback/${id}`);
    if (!res.ok) throw new Error('Failed to load feedback');

    const fb = await res.json();
    currentFeedbackId = id;

    document.getElementById("modalEmail").textContent = fb.email;
    document.getElementById("modalMessage").textContent = fb.message;
    document.getElementById("modalDate").textContent = new Date(fb.createdAt).toLocaleString();

    const modalFooter = document.getElementById("modalFooter");
    modalFooter.innerHTML = `
      ${fb.userId === currentUserId ? `
        <button type="button" class="btn btn-danger" id="deleteBtn">Delete</button>
        <button type="button" class="btn btn-primary" id="editModalBtn">Edit</button>
      ` : ''}
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
    `;

    document.getElementById("deleteBtn")?.addEventListener("click", () => deleteFeedback(id));
    document.getElementById("editModalBtn")?.addEventListener("click", () => {
      bootstrap.Modal.getInstance(document.getElementById('feedbackModal')).hide();
      editFeedback(id);
    });

    new bootstrap.Modal(document.getElementById('feedbackModal')).show();
  } catch (error) {
    showAlert(error.message, 'danger');
  }
}

async function editFeedback(id) {
  try {
    const res = await fetch(`${API_BASE_URL}/feedback/${id}`);
    if (!res.ok) throw new Error('Failed to load feedback');

    const fb = await res.json();
    if (fb.userId !== currentUserId) throw new Error('You can only edit your own feedback');

    currentFeedbackId = id;
    document.getElementById("email").value = fb.email;
    document.getElementById("message").value = fb.message;

    document.getElementById("submitBtn").textContent = 'Update Feedback';
    cancelEditBtn.style.display = 'block';
    feedbackForm.scrollIntoView({ behavior: 'smooth' });
  } catch (error) {
    showAlert(error.message, 'danger');
  }
}

async function deleteFeedback(id) {
  if (!id) return;
  try {
    const confirmed = confirm("Are you sure you want to delete this feedback?");
    if (!confirmed) return;

    const res = await fetch(`${API_BASE_URL}/feedback/${id}`, {
      method: "DELETE"
    });

    if (!res.ok) throw new Error('Deletion failed');

    showAlert('Feedback deleted successfully!', 'success');
    bootstrap.Modal.getInstance(document.getElementById('feedbackModal')).hide();
    await fetchFeedbacks();
    currentFeedbackId = null;
  } catch (error) {
    showAlert(error.message, 'danger');
  }
}

function cancelEdit() {
  feedbackForm.reset();
  currentFeedbackId = null;
  cancelEditBtn.style.display = 'none';
  document.getElementById("submitBtn").textContent = 'Submit Feedback';
}

function showAlert(message, type) {
  feedbackResponse.textContent = message;
  feedbackResponse.className = `alert alert-${type}`;
  feedbackResponse.classList.remove("d-none");
  setTimeout(() => {
    feedbackResponse.classList.add("d-none");
  }, 3000);
}

function setupFormValidation() {
  feedbackForm.addEventListener('input', () => {
    const isValid = feedbackForm.checkValidity();
    document.getElementById("submitBtn").disabled = !isValid;
  });
}

// FAQ Loading Function
async function loadFAQs() {
  const faqContainer = document.querySelector('.faq-items-container');
  
  try {
    // Loading state with accessibility
    faqContainer.innerHTML = `
      <div role="status" aria-live="polite" class="flex flex-col items-center justify-center py-8 space-y-3">
        <div class="animate-spin rounded-full h-8 w-8 border-4 border-purple-200 border-t-purple-600" aria-hidden="true"></div>
        <p class="text-gray-600">Loading FAQs...</p>
      </div>
    `;

    const response = await fetch('http://localhost:3000/api/tickets/faqs');
    
    if (!response.ok) {
      throw new Error(`Failed to load: ${response.status}`);
    }

    const faqs = await response.json();
    
    if (!faqs?.length) {
      throw new Error('No FAQs available');
    }

    faqContainer.innerHTML = faqs.map((faq, index) => `
      <div class="border border-gray-200 rounded-lg overflow-hidden shadow-sm mb-4 last:mb-0">
        <button
          id="faq-btn-${index}"
          class="w-full px-5 py-4 text-left flex justify-between items-center bg-gray-50 hover:bg-gray-100 transition-colors focus:outline-none focus:ring-2 focus:ring-purple-500"
          aria-expanded="false"
          aria-controls="faq-content-${index}"
          onclick="toggleFAQ(${index})"
        >
          <h3 class="font-medium text-gray-800 text-left">${faq.question}</h3>
          <svg 
            id="faq-icon-${index}"
            class="w-5 h-5 text-gray-500 transform transition-transform duration-200"
            fill="none" 
            viewBox="0 0 24 24" 
            stroke="currentColor"
            aria-hidden="true"
          >
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        <div
          id="faq-content-${index}"
          class="hidden px-5 py-4 bg-white border-t border-gray-100"
          aria-labelledby="faq-btn-${index}"
        >
          <p class="text-gray-600">${faq.answer}</p>
        </div>
      </div>
    `).join('');

  } catch (error) {
    console.error('FAQ loading error:', error);
    faqContainer.innerHTML = `
      <div role="alert" aria-live="assertive" class="px-4 py-3 bg-red-50 border-l-4 border-red-500 text-red-700">
        <p class="flex items-center">
          <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
          </svg>
          ${error.message || 'Failed to load FAQs'}
        </p>
        <button 
          onclick="loadFAQs()" 
          class="mt-2 px-3 py-1 text-sm font-medium text-red-600 hover:text-red-800 hover:underline focus:outline-none focus:ring-2 focus:ring-red-500"
        >
          Retry
        </button>
      </div>
    `;
  }
}

// Toggle function for FAQ items
function toggleFAQ(index) {
  const button = document.getElementById(`faq-btn-${index}`);
  const content = document.getElementById(`faq-content-${index}`);
  const icon = document.getElementById(`faq-icon-${index}`);
  
  const isExpanded = button.getAttribute('aria-expanded') === 'true';
  
  // Toggle visibility
  content.classList.toggle('hidden');
  icon.classList.toggle('rotate-180');
  
  // Update ARIA attributes
  button.setAttribute('aria-expanded', !isExpanded);
}

</script>
<script src = "/js/sidebar_script.js"></script>
<script>
  document.querySelectorAll(".faq-toggle").forEach(button => {
    button.addEventListener("click", () => {
      const content = button.nextElementSibling;
      const icon = button.querySelector("svg");

      content.classList.toggle("hidden");
      icon.classList.toggle("rotate-180");
    });
  });

</script>

<script>
// Update the user info loading script
window.addEventListener("DOMContentLoaded", async () => {
  const userSession = JSON.parse(localStorage.getItem("userSession"));
  
  if (!userSession) {
    window.location.href = "General.html";
    return;
  }

  // Set username fallback
  const usernameElement = document.getElementById("username");
  usernameElement.textContent = userSession.name || "User";
  
  // Set email in form if available
  if (userSession.email) {
    document.getElementById("email").value = userSession.email;
  }

  try {
    const res = await fetch(`/api/users/${userSession._id || userSession.id}`);
    if (res.ok) {
      const data = await res.json();
      if (data.email) {
        document.getElementById("email").value = data.email;
      }
    }
  } catch (err) {
    console.error("User info fetch error:", err);
  }
});
</script>

</body>
</html>
