<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Help & Support</title>

  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href = "/css/sidebar.css" rel="stylesheet">

<style>
    :root {
  --bs-primary: #6f42c1;
  --bs-primary-dark: #5a32a3;
  --bs-light-bg: #f4f0fa;
}

body {
  /* font-family: 'Poppins', sans-serif; */
  background-color: var(--bs-light-bg);
  margin: 0;
}

.main-content {
  margin-left: 90px;
  padding: 2rem;
  flex-grow: 1;
  padding-top: 90px; /* ← Push content below the fixed header */
  font-family: 'Poppins';
  position: relative;
  width: calc(100% - 78px);
  left: 50px;
  justify-content: center;
  flex: 1 0 auto;
}


  header {
    background-color: rgb(222, 204, 255);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    padding: 1rem;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    text-align: center;
    justify-content: center;
    z-index: 1001;
    height: 70px;
  }

  .header-container{
    display: flex;
    justify-content: space-between;
  }

  header ul{
    justify-content: space-between;
    display: flex;
    gap: 10rem;
  }

body, html {
  height: 100%;
  margin: 0;
  display: flex;
  flex-direction: column;
}

/* Only fix the arrow conflict from Tailwind's preflight */
.accordion-button::after {
  background-image: none !important;
}

</style>

</head>
<body class="min-h-screen flex flex-col">
<header class="items-center flex justify-content-between">
    <img src="./assets/images/fsktm-kpi-logo.png" alt="Logo" style="height: 60px; margin-left:30px">  
    <div>
      <ul class="flex gap-lg-5">
        <li id="username" class="text-lg justify-center text-[#2e067d] mt-1 font-medium"></li>
        <li class="mt-1">
          <a href="/General.html" class="text-lg text-[#2e067d] border-2 border-[#2e067d] py-1 px-3 rounded-lg 
            hover:bg-[#2e067d] hover:text-white transition duration-200">
            Logout
          </a>
        </li>
      </ul>
    </div>
  </header>

  <div class="flex flex-1">
  <!-- Side Navigation Bar -->
  <div class = "sidebar">
    <div class = "logo_content">
      <div class="logo">
          <i class='bx bxs-bar-chart-alt-2'></i>
          <div class="logo_name">FSKTM KPI Tracker</div>
        </div>
      <i class='bx bx-menu' id = "btn" >
        <span class = "tooltip">Menu</span>
      </i>
      <ul class="nav_list">
        <li>
          <a href = "profile.html">
            <i class='bx bx-user'></i>
            <span class="links_name">My Account</span>
          </a>
          <span class="tooltip">My Account</span>
        </li>
        <li>
          <a href="LecturerDashboard.html">
            <i class='bx bxs-dashboard'></i>
            <span class="links_name">Lecturer Dashboard</span>
          </a>
          <span class="tooltip">KPI Dashboard</span>
          
          <!--Revisit-->
          <!-- Submenu starts here -->
          <!-- <ul class="submenu">
            <li><a href="#">KPI Overview</a></li>
            <li><a href="#">KPI Management</a></li>
            <li><a href="#">KPI Verification</a></li>
          </ul>
        </li> -->

        <li>
          <a href = "Student_Dash.html">
            <i class='bx bxs-dashboard' ></i>
            <span class="links_name">Student Dashboard</span>
          </a>
          <span class="tooltip">KPI Dashboard</span>
        </li>
        <li>
          <a href = "notification.html">
            <i class='bx bxs-bell'></i>
            <span class="links_name">Notifications</span>
          </a>
          <span class="tooltip">Notifications</span>
        </li>
        <li>
          <a href = "help.html">
            <i class='bx bx-question-mark'></i>
            <span class="links_name">Help & Support</span>
          </a>
          <span class="tooltip">Help & Support</span>
        </li>
      </ul>
    </div>
  </div>

     <main class="flex-1 p-4 bg-gray-100 mainPage">
      <div class="main-content">
        <h2 class="mb-4 fw-bold fs-2">Help & Support</h2>

<!-- FAQ Section -->
<div class="mb-5">
  <h4 class="text-xl font-semibold mb-5 text-gray-800">Frequently Asked Questions</h4>
  <button onclick="loadFAQs()" class="btn btn-sm btn-outline-primary mb-3">
    Load FAQs
  </button>
  <div class="faq-items-container"></div>
</div>

<!-- Feedback Section -->
<div class="feedback-section">
  <!-- Feedback Form -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h4 class="mb-0">Submit Feedback</h4>
    </div>
    <div class="card-body">
      <form id="feedbackForm" class="mb-4">
        <input type="hidden" id="feedbackId">
        <div class="mb-3">
          <label for="user" class="form-label">Your Name</label>
          <input type="text" id="user" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="email" class="form-label">Your Email</label>
          <input type="email" id="email" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="message" class="form-label">Message</label>
          <textarea id="message" rows="4" class="form-control" required></textarea>
        </div>
        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-primary flex-grow-1" id="submitBtn">
            Submit Feedback
          </button>
          <button type="button" class="btn btn-outline-secondary" id="cancelEditBtn" style="display: none;">
            Cancel Edit
          </button>
        </div>
      </form>
      
      <!-- Feedback Response Alert -->
      <div id="feedbackResponse" class="alert d-none"></div>
    </div>
  </div>

  <!-- Feedback List -->
  <div class="card">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Submitted Feedback</h5>
      <button class="btn btn-sm btn-outline-primary" id="refreshFeedbackBtn">
        <i class="bi bi-arrow-clockwise"></i> Refresh
      </button>
    </div>
    <div class="card-body p-0">
      <ul id="feedbackList" class="list-group list-group-flush">
        <li class="list-group-item text-center py-4 text-muted">
          Loading feedback...
        </li>
      </ul>
    </div>
  </div>
</div>

<!-- Feedback Details Modal -->
<div class="modal fade" id="feedbackModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Feedback Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="modalContent">
        <div class="mb-3">
          <label class="form-label text-muted small">Name</label>
          <p id="modalName" class="mb-2"></p>
        </div>
        <div class="mb-3">
          <label class="form-label text-muted small">Email</label>
          <p id="modalEmail" class="mb-2"></p>
        </div>
        <div class="mb-3">
          <label class="form-label text-muted small">Message</label>
          <p id="modalMessage" class="mb-2"></p>
        </div>
        <div class="mb-3">
          <label class="form-label text-muted small">Submitted</label>
          <p id="modalDate" class="mb-2"></p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" id="deleteBtn">
          <i class="bi bi-trash"></i> Delete
        </button>
        <button type="button" class="btn btn-primary" id="editModalBtn">
          <i class="bi bi-pencil"></i> Edit
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

 </main>
  </div>

<footer class="h-50 bg-[#2C0057] ml-[78px] flex items-center justify-between">
      <img src="./assets/images/fsktm-kpi-logo-white.png" alt="KPI-Logo" class="w-1/4 h-[210px] ">

      <div>
        <ul class="text-white text-start">
          <h2 class="text-xl font-semibold mb-1">Contact Us</h2>
          <li class="mb-1/2">kpi-admin@fsktm.um.edu.my</li>
          <li class="mb-1/2">company address</li>
          <li>+60 12 - 768 4400</li>
        </ul>
      </div>

      <p class="text-white text-sm mr-10">COPYRIGHT 2025 © FSKTM KPI Tracker</p>
</footer>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
 async function loadFAQs() {
  const faqContainer = document.querySelector('.faq-items-container');
  
  try {
    // Show loading state
    faqContainer.innerHTML = `
      <div class="text-center py-4">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading FAQs...</p>
      </div>
    `;

    const res = await fetch('http://localhost:3000/api/tickets/faqs');
    
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }

    const faqs = await res.json();
    
    if (!faqs || faqs.length === 0) {
      throw new Error('No FAQs found');
    }

    faqContainer.innerHTML = faqs.map(faq => `
      <div class="faq-item card mb-3">
        <div class="card-header bg-light" data-bs-toggle="collapse" href="#faq-${faq._id}">
          <h5 class="mb-0 d-flex justify-content-between align-items-center">
            ${faq.question}
            <i class="bi bi-chevron-down"></i>
          </h5>
        </div>
        <div id="faq-${faq._id}" class="collapse">
          <div class="card-body">
            ${faq.answer}
          </div>
        </div>
      </div>
    `).join('');

  } catch (error) {
    console.error("FAQ loading error:", error);
    faqContainer.innerHTML = `
      <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle-fill"></i>
        Failed to load FAQs. Please try again later.
        <button onclick="loadFAQs()" class="btn btn-sm btn-link">Retry</button>
      </div>
    `;
  }
}
</script>

<script>
  // DOM Elements
  const feedbackForm = document.getElementById("feedbackForm");
  const feedbackResponse = document.getElementById("feedbackResponse");
  const feedbackList = document.getElementById("feedbackList");
  const modalContent = document.getElementById("modalContent");
  const deleteBtn = document.getElementById("deleteBtn");
  let currentFeedbackId = null;

  // Base API URL
  const API_BASE_URL = 'http://localhost:3000/api/tickets';

  // Initialize on page load
  document.addEventListener("DOMContentLoaded", () => {
    fetchFeedbacks();
    setupFormValidation();
  });

  // Form Submission
  feedbackForm.addEventListener("submit", async function (e) {
    e.preventDefault();
    const submitBtn = this.querySelector('button[type="submit"]');
   
    try {
      // Show loading state
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Submitting...';

      const feedbackData = {
        name: document.getElementById("user").value.trim(), 
        email: document.getElementById("email").value.trim(),
        message: document.getElementById("message").value.trim()
      };

      // Create or Update based on currentFeedbackId
      const url = currentFeedbackId 
        ? `${API_BASE_URL}/feedback/${currentFeedbackId}`
        : `${API_BASE_URL}/feedback`;
        
      const method = currentFeedbackId ? 'PUT' : 'POST';

      const res = await fetch(url, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(feedbackData)
      });

      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.message || 'Operation failed');
      }

      // Success handling
      feedbackForm.reset();
      showAlert('Feedback submitted successfully!', 'success');
      currentFeedbackId = null; // Reset for new submissions
      await fetchFeedbacks();
      
    } catch (error) {
      showAlert(error.message, 'danger');
      console.error("Error:", error);
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = 'Submit Feedback';
    }
  });

  // Fetch all feedback
  async function fetchFeedbacks() {
    feedbackList.innerHTML = '<li class="list-group-item text-center py-3">Loading feedback...</li>';
    
    try {
      const res = await fetch(`${API_BASE_URL}/feedback`);
      if (!res.ok) throw new Error('Failed to load feedback');
      
      const feedbacks = await res.json();
      renderFeedbacks(feedbacks);
      
    } catch (error) {
      feedbackList.innerHTML = `
        <li class="list-group-item text-center text-danger py-3">
          ${error.message}
          <button onclick="fetchFeedbacks()" class="btn btn-sm btn-link">Retry</button>
        </li>
      `;
    }
  }

  // Render feedback list
  function renderFeedbacks(feedbacks) {
    feedbackList.innerHTML = feedbacks.length > 0 
      ? feedbacks.map(fb => `
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <strong>${fb.name || fb.user}</strong>
              <small class="text-muted d-block">${fb.email}</small>
              <div>${fb.message.substring(0, 50)}...</div>
            </div>
            <div>
              <button onclick="editFeedback('${fb._id}')" class="btn btn-sm btn-outline-primary me-2">
                Edit
              </button>
              <button onclick="viewFeedback('${fb._id}')" class="btn btn-sm btn-outline-info">
                View
              </button>
            </div>
          </li>
        `).join('')
      : '<li class="list-group-item text-center py-3">No feedback submitted yet</li>';
  }

  // View feedback details
  async function viewFeedback(id) {
    try {
      const res = await fetch(`${API_BASE_URL}/feedback/${id}`);
      if (!res.ok) throw new Error('Failed to load feedback');
      
      const fb = await res.json();
      currentFeedbackId = id;

      modalContent.innerHTML = `
        <p><strong>Name:</strong> ${fb.name || fb.user}</p>
        <p><strong>Email:</strong> ${fb.email}</p>
        <p><strong>Message:</strong><br>${fb.message}</p>
        <p><strong>Submitted:</strong> ${new Date(fb.createdAt).toLocaleString()}</p>
      `;

      new bootstrap.Modal(document.getElementById('feedbackModal')).show();
    } catch (error) {
      showAlert(error.message, 'danger');
    }
  }

  // Edit feedback
  async function editFeedback(id) {
    try {
      const res = await fetch(`${API_BASE_URL}/feedback/${id}`);
      if (!res.ok) throw new Error('Failed to load feedback');
      
      const fb = await res.json();
      currentFeedbackId = id;

      // Populate form
      document.getElementById("user").value = fb.name || fb.user;
      document.getElementById("email").value = fb.email;
      document.getElementById("message").value = fb.message;
      
      // Change button text
      feedbackForm.querySelector('button[type="submit"]').textContent = 'Update Feedback';
      
      // Scroll to form
      feedbackForm.scrollIntoView({ behavior: 'smooth' });
    } catch (error) {
      showAlert(error.message, 'danger');
    }
  }

  // Delete feedback
  deleteBtn.addEventListener("click", async () => {
    if (!currentFeedbackId) return;
    try {
      const confirmed = confirm("Are you sure you want to delete this feedback?");
      if (!confirmed) return;

      const res = await fetch(`${API_BASE_URL}/feedback/${currentFeedbackId}`, {
        method: "DELETE"
      });

      if (!res.ok) throw new Error('Deletion failed');

      showAlert('Feedback deleted successfully!', 'success');
      bootstrap.Modal.getInstance(document.getElementById('feedbackModal')).hide();
      await fetchFeedbacks();
      currentFeedbackId = null;
    } catch (error) {
      showAlert(error.message, 'danger');
    }
  });

  // Helper function to show alerts
  function showAlert(message, type) {
    feedbackResponse.textContent = message;
    feedbackResponse.className = `alert alert-${type}`;
    feedbackResponse.classList.remove("d-none");
    
    setTimeout(() => {
      feedbackResponse.classList.add("d-none");
    }, 3000);
  }

  // Form validation
  function setupFormValidation() {
    feedbackForm.addEventListener('input', () => {
      const isValid = feedbackForm.checkValidity();
      feedbackForm.querySelector('button[type="submit"]').disabled = !isValid;
    });
  }

</script>
<script src = "/js/sidebar_script.js"></script>
<script>
  document.querySelectorAll(".faq-toggle").forEach(button => {
    button.addEventListener("click", () => {
      const content = button.nextElementSibling;
      const icon = button.querySelector("svg");

      content.classList.toggle("hidden");
      icon.classList.toggle("rotate-180");
    });
  });
</script>
<script>
      window.addEventListener("DOMContentLoaded", async () => {
        const session = JSON.parse(localStorage.getItem("userSession"));
        if (!session || !session.id) {
          alert("No user session found. Please log in.");
          window.location.href = "General.html";
          return;
        }

        try {
          const res = await fetch(`/api/students/${session.id}`);
          const data = await res.json();

          if (res.ok && data.user) {
            // ✅ Update the header name to match profile.html
            document.getElementById("username").textContent = data.user.name;
          } else {
            throw new Error(data.message || "User not found");
          }
        } catch (err) {
          console.error(err);
          alert("Failed to load user info.");
        }
      });
    </script>

</body>
</html>
